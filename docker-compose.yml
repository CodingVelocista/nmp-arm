# Use postgres/example user/password credentials
version: '3.7'

services:
  # PGPASSWORD=$POSTGRES_PASSWORD psql -h $HOSTNAME -U $POSTGRES_USER $POSTGRES_DB
  db:
    image: mdillon/postgis:9.6-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: bcarm
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres-passwd
    volumes:
       - ./openshift/postgis-config/secrets:/run/secrets
       - ./openshift/postgis-config/data:/var/lib/postgresql/data
       - ./openshift/postgis-config/initdb:/docker-entrypoint-initdb.d

  web:
    image: nginx:1.17
    volumes:
    - ./openshift/nginx-config/bcarm.template:/etc/nginx/conf.d/bcarm.template
    ports:
    - "8080:80"
    environment:
    - NGINX_HOST=bcarm.local
    - NGINX_PORT=80
    - ENVIRONMENT: dev
      DEBUG: 'False'
      LOGGER_LEVEL: WARNING
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      ADMIN_EMAIL: ${DEFAULT_EMAIL}
      DEFAULT_FROM_EMAIL: ${DEFAULT_EMAIL}
      EMAIL_TO: ${DEFAULT_EMAIL}
      SERVER_EMAIL: ${DEFAULT_EMAIL}
      SUPPORT_EMAIL: ${DEFAULT_EMAIL}
      WEASYPRINT_URL: ${WEASYPRINT_URL}
#    command: /bin/bash -c "envsubst < /etc/nginx/conf.d/bcarm.template > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
    depends_on:
    - db

#  adminer:
#    image: adminer
#    restart: always
#    ports:
#      - 8080:8080

# services:

#   web:
#     image: arm-bc-web:latest
#     container_name: arm-bc-web
#     build: ./app/backend
#     command: python manage.py runserver 0.0.0.0:8000
#     stdin_open: true
#     tty: true
#     volumes:
#       - ./app/backend:/code
#     ports:
#       - "8000:8000"
      
#     environment:
#       ENVIRONMENT: dev
#       DEBUG: 'False'
#       LOGGER_LEVEL: WARNING
#       DATABASE_HOST: ${DATABASE_HOST}
#       DATABASE_NAME: ${DATABASE_NAME}
#       DATABASE_USER: ${DATABASE_USER}
#       DATABASE_PASSWORD: ${DATABASE_PASSWORD}
#       ADMIN_EMAIL: ${DEFAULT_EMAIL}
#       DEFAULT_FROM_EMAIL: ${DEFAULT_EMAIL}
#       EMAIL_TO: ${DEFAULT_EMAIL}
#       SERVER_EMAIL: ${DEFAULT_EMAIL}
#       SUPPORT_EMAIL: ${DEFAULT_EMAIL}
#       WEASYPRINT_URL: ${WEASYPRINT_URL}

